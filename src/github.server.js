import url from "url";
import dotenv from "dotenv";
import octokit from "@octokit/rest";
const atob = require("atob");
import fetch from "node-fetch";
dotenv.config();
const jsonwebtoken = require("jsonwebtoken");

const ISSUER_ID = 22104; // replace with the ID of your github app
const PEM = atob(process.env.GITHUB_PEM);

const config = {
  iat: Math.floor(new Date() / 1000),
  exp: Math.floor(new Date() / 1000) + 5 * 60,
  iss: ISSUER_ID
};

function generateJwtToken() {
  return jsonwebtoken.sign(config, PEM, { algorithm: "RS256" });
}

const octokitClient = octokit();

const iframe = `<div id="root"><div style="background:#1E1E1E;border:1px solid rgba(212, 212, 212, 0.5);border-radius:3px;display:flex;flex-direction:column;box-sizing:border-box;height:100%" tabindex="0"><div style="flex:1;padding:0px 7px;overflow:hidden"><pre style="margin:0;overflow:hidden;text-align:center;position:relative;color:#D4D4D4;background-color:#1E1E1E" class="prism-code language-jsx"><div style="position:relative"><code class="scroll-content undefined" style="display:inline-block;text-align:left;width:100%"><div class="token-line" style="color:#D4D4D4"><style>.css-oeiq0y,[data-css-oeiq0y]{opacity:1;transition:opacity 300ms;-webkit-transition:opacity 300ms;-moz-transition:opacity 300ms;}</style><span class="scroll-selected token keyword css-oeiq0y" style="color:rgb(86, 156, 214)">const</span><span class="scroll-selected token plain css-oeiq0y"> </span><span class="scroll-selected token constant css-oeiq0y" style="color:rgb(100, 102, 149)">ENOUGH_TIME</span><span class="scroll-selected token plain css-oeiq0y"> </span><span class="scroll-selected token operator css-oeiq0y" style="color:rgb(212, 212, 212)">=</span><span class="scroll-selected token plain css-oeiq0y"> </span><span class="scroll-selected token number css-oeiq0y" style="color:rgb(181, 206, 168)">1</span><span class="scroll-selected token punctuation css-oeiq0y" style="color:rgb(86, 156, 214)">;</span><span class="scroll-selected token plain css-oeiq0y"> </span><span class="scroll-selected token comment css-oeiq0y" style="color:rgb(106, 153, 85)">// milliseconds</span><span class="scroll-selected token plain css-oeiq0y"></span></div><div class="token-line" style="color:#D4D4D4"><span class="scroll-selected token plain css-oeiq0y" style="display:inline-block"></span></div><div class="token-line" style="color:#D4D4D4"><span class="scroll-selected token plain css-oeiq0y"></span><span class="scroll-selected token keyword css-oeiq0y" style="color:rgb(86, 156, 214)">let</span><span class="scroll-selected token plain css-oeiq0y"> workQueue </span><span class="scroll-selected token operator css-oeiq0y" style="color:rgb(212, 212, 212)">=</span><span class="scroll-selected token plain css-oeiq0y"> </span><span class="scroll-selected token punctuation css-oeiq0y" style="color:rgb(86, 156, 214)">[</span><span class="scroll-selected token punctuation css-oeiq0y" style="color:rgb(86, 156, 214)">]</span><span class="scroll-selected token punctuation css-oeiq0y" style="color:rgb(86, 156, 214)">;</span><span class="scroll-selected token plain css-oeiq0y"></span></div><div class="token-line" style="color:#D4D4D4"><span class="scroll-selected token plain css-oeiq0y"></span><span class="scroll-selected token keyword css-oeiq0y" style="color:rgb(86, 156, 214)">let</span><span class="scroll-selected token plain css-oeiq0y"> nextUnitOfWork </span><span class="scroll-selected token operator css-oeiq0y" style="color:rgb(212, 212, 212)">=</span><span class="scroll-selected token plain css-oeiq0y"> </span><span class="scroll-selected token keyword css-oeiq0y" style="color:rgb(86, 156, 214)">null</span><span class="scroll-selected token punctuation css-oeiq0y" style="color:rgb(86, 156, 214)">;</span><span class="scroll-selected token plain css-oeiq0y"></span></div><div class="token-line" style="color:#D4D4D4"><span class="scroll-selected token plain css-oeiq0y" style="display:inline-block"></span></div><div class="token-line" style="color:#D4D4D4"><span class="scroll-selected token plain css-oeiq0y"></span><span class="scroll-selected token keyword css-oeiq0y" style="color:rgb(86, 156, 214)">function</span><span class="scroll-selected token plain css-oeiq0y"> </span><span class="scroll-selected token function css-oeiq0y" style="color:rgb(220, 220, 170)">schedule</span><span class="scroll-selected token punctuation css-oeiq0y" style="color:rgb(86, 156, 214)">(</span><span class="scroll-selected token plain css-oeiq0y">task</span><span class="scroll-selected token punctuation css-oeiq0y" style="color:rgb(86, 156, 214)">)</span><span class="scroll-selected token plain css-oeiq0y"> </span><span class="scroll-selected token punctuation css-oeiq0y" style="color:rgb(86, 156, 214)">{</span><span class="scroll-selected token plain css-oeiq0y"></span></div><div class="token-line" style="color:#D4D4D4"><span class="scroll-selected token plain css-oeiq0y">  workQueue</span><span class="scroll-selected token punctuation css-oeiq0y" style="color:rgb(86, 156, 214)">.</span><span class="scroll-selected token function css-oeiq0y" style="color:rgb(220, 220, 170)">push</span><span class="scroll-selected token punctuation css-oeiq0y" style="color:rgb(86, 156, 214)">(</span><span class="scroll-selected token plain css-oeiq0y">task</span><span class="scroll-selected token punctuation css-oeiq0y" style="color:rgb(86, 156, 214)">)</span><span class="scroll-selected token punctuation css-oeiq0y" style="color:rgb(86, 156, 214)">;</span><span class="scroll-selected token plain css-oeiq0y"></span></div><div class="token-line" style="color:#D4D4D4"><span class="scroll-selected token plain css-oeiq0y">  </span><span class="scroll-selected token function css-oeiq0y" style="color:rgb(220, 220, 170)">requestIdleCallback</span><span class="scroll-selected token punctuation css-oeiq0y" style="color:rgb(86, 156, 214)">(</span><span class="scroll-selected token plain css-oeiq0y">performWork</span><span class="scroll-selected token punctuation css-oeiq0y" style="color:rgb(86, 156, 214)">)</span><span class="scroll-selected token punctuation css-oeiq0y" style="color:rgb(86, 156, 214)">;</span><span class="scroll-selected token plain css-oeiq0y"></span></div><div class="token-line" style="color:#D4D4D4"><span class="scroll-selected token plain css-oeiq0y"></span><span class="scroll-selected token punctuation css-oeiq0y" style="color:rgb(86, 156, 214)">}</span><span class="scroll-selected token plain css-oeiq0y"></span></div><div class="token-line" style="color:#D4D4D4"><span class="scroll-selected token plain css-oeiq0y" style="display:inline-block"></span></div><div class="token-line" style="color:#D4D4D4"><span class="scroll-selected token plain css-oeiq0y"></span><span class="scroll-selected token keyword css-oeiq0y" style="color:rgb(86, 156, 214)">function</span><span class="scroll-selected token plain css-oeiq0y"> </span><span class="scroll-selected token function css-oeiq0y" style="color:rgb(220, 220, 170)">performWork</span><span class="scroll-selected token punctuation css-oeiq0y" style="color:rgb(86, 156, 214)">(</span><span class="scroll-selected token plain css-oeiq0y">deadline</span><span class="scroll-selected token punctuation css-oeiq0y" style="color:rgb(86, 156, 214)">)</span><span class="scroll-selected token plain css-oeiq0y"> </span><span class="scroll-selected token punctuation css-oeiq0y" style="color:rgb(86, 156, 214)">{</span><span class="scroll-selected token plain css-oeiq0y"></span></div><div class="token-line" style="color:#D4D4D4"><span class="scroll-selected token plain css-oeiq0y">  </span><span class="scroll-selected token keyword css-oeiq0y" style="color:rgb(86, 156, 214)">if</span><span class="scroll-selected token plain css-oeiq0y"> </span><span class="scroll-selected token punctuation css-oeiq0y" style="color:rgb(86, 156, 214)">(</span><span class="scroll-selected token operator css-oeiq0y" style="color:rgb(212, 212, 212)">!</span><span class="scroll-selected token plain css-oeiq0y">nextUnitOfWork</span><span class="scroll-selected token punctuation css-oeiq0y" style="color:rgb(86, 156, 214)">)</span><span class="scroll-selected token plain css-oeiq0y"> </span><span class="scroll-selected token punctuation css-oeiq0y" style="color:rgb(86, 156, 214)">{</span><span class="scroll-selected token plain css-oeiq0y"></span></div><div class="token-line" style="color:#D4D4D4"><span class="scroll-selected token plain css-oeiq0y">    nextUnitOfWork </span><span class="scroll-selected token operator css-oeiq0y" style="color:rgb(212, 212, 212)">=</span><span class="scroll-selected token plain css-oeiq0y"> workQueue</span><span class="scroll-selected token punctuation css-oeiq0y" style="color:rgb(86, 156, 214)">.</span><span class="scroll-selected token function css-oeiq0y" style="color:rgb(220, 220, 170)">shift</span><span class="scroll-selected token punctuation css-oeiq0y" style="color:rgb(86, 156, 214)">(</span><span class="scroll-selected token punctuation css-oeiq0y" style="color:rgb(86, 156, 214)">)</span><span class="scroll-selected token punctuation css-oeiq0y" style="color:rgb(86, 156, 214)">;</span><span class="scroll-selected token plain css-oeiq0y"></span></div><div class="token-line" style="color:#D4D4D4"><span class="scroll-selected token plain css-oeiq0y">  </span><span class="scroll-selected token punctuation css-oeiq0y" style="color:rgb(86, 156, 214)">}</span><span class="scroll-selected token plain css-oeiq0y"></span></div><div class="token-line" style="color:#D4D4D4"><span class="scroll-selected token plain css-oeiq0y" style="display:inline-block"></span></div><div class="token-line" style="color:#D4D4D4"><span class="scroll-selected token plain css-oeiq0y">  </span><span class="scroll-selected token keyword css-oeiq0y" style="color:rgb(86, 156, 214)">while</span><span class="scroll-selected token plain css-oeiq0y"> </span><span class="scroll-selected token punctuation css-oeiq0y" style="color:rgb(86, 156, 214)">(</span><span class="scroll-selected token plain css-oeiq0y">nextUnitOfWork </span><span class="scroll-selected token operator css-oeiq0y" style="color:rgb(212, 212, 212)">&amp;&amp;</span><span class="scroll-selected token plain css-oeiq0y"> deadline</span><span class="scroll-selected token punctuation css-oeiq0y" style="color:rgb(86, 156, 214)">.</span><span class="scroll-selected token function css-oeiq0y" style="color:rgb(220, 220, 170)">timeRemaining</span><span class="scroll-selected token punctuation css-oeiq0y" style="color:rgb(86, 156, 214)">(</span><span class="scroll-selected token punctuation css-oeiq0y" style="color:rgb(86, 156, 214)">)</span><span class="scroll-selected token plain css-oeiq0y"> </span><span class="scroll-selected token operator css-oeiq0y" style="color:rgb(212, 212, 212)">&gt;</span><span class="scroll-selected token plain css-oeiq0y"> </span><span class="scroll-selected token constant css-oeiq0y" style="color:rgb(100, 102, 149)">ENOUGH_TIME</span><span class="scroll-selected token punctuation css-oeiq0y" style="color:rgb(86, 156, 214)">)</span><span class="scroll-selected token plain css-oeiq0y"> </span><span class="scroll-selected token punctuation css-oeiq0y" style="color:rgb(86, 156, 214)">{</span><span class="scroll-selected token plain css-oeiq0y"></span></div><div class="token-line" style="color:#D4D4D4"><span class="scroll-selected token plain css-oeiq0y">    nextUnitOfWork </span><span class="scroll-selected token operator css-oeiq0y" style="color:rgb(212, 212, 212)">=</span><span class="scroll-selected token plain css-oeiq0y"> </span><span class="scroll-selected token function css-oeiq0y" style="color:rgb(220, 220, 170)">performUnitOfWork</span><span class="scroll-selected token punctuation css-oeiq0y" style="color:rgb(86, 156, 214)">(</span><span class="scroll-selected token plain css-oeiq0y">nextUnitOfWork</span><span class="scroll-selected token punctuation css-oeiq0y" style="color:rgb(86, 156, 214)">)</span><span class="scroll-selected token punctuation css-oeiq0y" style="color:rgb(86, 156, 214)">;</span><span class="scroll-selected token plain css-oeiq0y"></span></div><div class="token-line" style="color:#D4D4D4"><span class="scroll-selected token plain css-oeiq0y">  </span><span class="scroll-selected token punctuation css-oeiq0y" style="color:rgb(86, 156, 214)">}</span><span class="scroll-selected token plain css-oeiq0y"></span></div><div class="token-line" style="color:#D4D4D4"><span class="scroll-selected token plain css-oeiq0y" style="display:inline-block"></span></div><div class="token-line" style="color:#D4D4D4"><span class="scroll-selected token plain css-oeiq0y">  </span><span class="scroll-selected token keyword css-oeiq0y" style="color:rgb(86, 156, 214)">if</span><span class="scroll-selected token plain css-oeiq0y"> </span><span class="scroll-selected token punctuation css-oeiq0y" style="color:rgb(86, 156, 214)">(</span><span class="scroll-selected token plain css-oeiq0y">nextUnitOfWork </span><span class="scroll-selected token operator css-oeiq0y" style="color:rgb(212, 212, 212)">||</span><span class="scroll-selected token plain css-oeiq0y"> workQueue</span><span class="scroll-selected token punctuation css-oeiq0y" style="color:rgb(86, 156, 214)">.</span><span class="scroll-selected token plain css-oeiq0y">length </span><span class="scroll-selected token operator css-oeiq0y" style="color:rgb(212, 212, 212)">&gt;</span><span class="scroll-selected token plain css-oeiq0y"> </span><span class="scroll-selected token number css-oeiq0y" style="color:rgb(181, 206, 168)">0</span><span class="scroll-selected token punctuation css-oeiq0y" style="color:rgb(86, 156, 214)">)</span><span class="scroll-selected token plain css-oeiq0y"> </span><span class="scroll-selected token punctuation css-oeiq0y" style="color:rgb(86, 156, 214)">{</span><span class="scroll-selected token plain css-oeiq0y"></span></div><div class="token-line" style="color:#D4D4D4"><span class="scroll-selected token plain css-oeiq0y">    </span><span class="scroll-selected token function css-oeiq0y" style="color:rgb(220, 220, 170)">requestIdleCallback</span><span class="scroll-selected token punctuation css-oeiq0y" style="color:rgb(86, 156, 214)">(</span><span class="scroll-selected token plain css-oeiq0y">performWork</span><span class="scroll-selected token punctuation css-oeiq0y" style="color:rgb(86, 156, 214)">)</span><span class="scroll-selected token punctuation css-oeiq0y" style="color:rgb(86, 156, 214)">;</span><span class="scroll-selected token plain css-oeiq0y"></span></div><div class="token-line" style="color:#D4D4D4"><span class="scroll-selected token plain css-oeiq0y">  </span><span class="scroll-selected token punctuation css-oeiq0y" style="color:rgb(86, 156, 214)">}</span><span class="scroll-selected token plain css-oeiq0y"></span></div><div class="token-line" style="color:#D4D4D4"><span class="scroll-selected token plain css-oeiq0y"></span><span class="scroll-selected token punctuation css-oeiq0y" style="color:rgb(86, 156, 214)">}</span></div></code></div></pre></div><div style="padding:7px 7px;color:rgba(212, 212, 212, 0.9);border-top:1px solid rgba(212, 212, 212, 0.09999999999999998);display:flex;justify-content:space-between;align-items:center"><span style="cursor:pointer;height:16px;flex:1;text-align:left"></span><span> all</span><span style="cursor:pointer;height:16px;flex:1;text-align:right"></span></div></div></div>`;

export async function getGithubContent(request, response) {
  octokitClient.authenticate({
    type: "app",
    token: generateJwtToken()
  });
  const {
    data: { token }
  } = await octokitClient.apps.createInstallationToken({
    installation_id: request.body.installation.id
  });

  // remove?
  octokitClient.authenticate({ type: "token", token });

  const contentId = request.body.content_reference.id;

  fetch(`https://api.github.com/content_references/${contentId}/attachments`, {
    method: "post",
    body: JSON.stringify({
      title: "Code Surfer",
      body: iframe
    }),
    headers: {
      Accept: "application/vnd.github.corsair-preview+json",
      Authorization: `Bearer ${token}`
    }
  })
    .then(res => res.json()) // expecting a json response
    .then(json => console.log(json));

  console.log("recieved");
  console.log(request.body);
  response.status(200).send("Hi");
}
